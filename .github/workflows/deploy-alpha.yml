name: Alpha ë°°í¬

on:
  workflow_dispatch:
    inputs:
      deployment_phase:
        description: 'ì•± ë°°í¬ ë‹¨ê³„ (ê¸°ë³¸ê°’: alpha). alpha, beta, production ì¤‘ ì„ íƒ. ì´ì™¸ì˜ ê°’ì€ í—ˆìš©ë˜ì§€ ì•ŠìŒ.'
        required: false
        type: string
        default: 'alpha'
      image_name:
        description: 'Docker ì´ë¯¸ì§€ ì´ë¦„ (ê¸°ë³¸ê°’: repository ì´ë¦„)'
        required: false
        type: string
      health_check_path:
        description: 'Health check endpoint ê²½ë¡œ (ê¸°ë³¸ê°’: /api/health)'
        required: false
        type: string
        default: '/api/health'
      ecr_base_name:
        description: 'ECR ê¸°ë³¸ ê²½ë¡œ (ê¸°ë³¸ê°’: aws-deploy-wizard)'
        required: false
        type: string
        default: 'aws-deploy-wizard'
      ecs_cluster_base_name:
        description: 'ECS Cluster ì´ë¦„ (ê¸°ë³¸ê°’: aws-deploy-wizard)'
        required: false
        type: string
        default: 'aws-deploy-wizard'

jobs:
  ## Docker image ë¹Œë“œ: ì• í”Œë¦¬ì¼€ì´ì…˜ì„ íŒ¨í‚¤ì§•í•©ë‹ˆë‹¤.
  build-docker-image:
    runs-on: ubuntu-latest
    environment: alpha
    permissions:
      id-token: write
      contents: read
    outputs:
      image_name: ${{ steps.set-image-name.outputs.image_name }}
      image_tag: ${{ steps.set-image-name.outputs.image_tag }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë‹¨ê³„ ê²€ì¦
        run: |
          if [ ${{ inputs.deployment_phase }} != "alpha" ] && [ ${{ inputs.deployment_phase }} != "beta" ] && [ ${{ inputs.deployment_phase }} != "production" ]; then
            echo "âŒ ì˜¤ë¥˜: ì˜ëª»ëœ deployment_phase ê°’ì…ë‹ˆë‹¤. í—ˆìš©ë˜ëŠ” ê°’ì€ 'alpha', 'beta', 'production' ì…ë‹ˆë‹¤."
            exit 1
          fi

      - name: ì´ë¯¸ì§€ ì´ë¦„ ë° íƒœê·¸ ì„¤ì •
        id: set-image-name
        run: |
          # Inputìœ¼ë¡œ ì´ë¯¸ì§€ ì´ë¦„ì´ ì œê³µë˜ì—ˆìœ¼ë©´ ì‚¬ìš©, ì•„ë‹ˆë©´ repository ì´ë¦„ ì‚¬ìš©
          if [ -n "${{ inputs.image_name }}" ]; then
            IMAGE_NAME="${{ inputs.image_name }}"
          else
            IMAGE_NAME="${{ github.event.repository.name }}"
          fi

          # íƒœê·¸ëŠ” git commit SHAì˜ ì§§ì€ ë²„ì „ ì‚¬ìš©
          IMAGE_TAG="${{ github.sha }}"
          IMAGE_TAG_SHORT="${IMAGE_TAG:0:7}"

          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG_SHORT}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ì´ë¦„: ${IMAGE_NAME}"
          echo "ğŸ·ï¸  Docker ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG_SHORT}"

      - name: Docker image ìƒì„±(ì• í”Œë¦¬ì¼€ì´ì…˜ íŒ¨í‚¤ì§•)   # Target ë°°í¬í™˜ê²½ì— ë”°ë¼ ì•„í‚¤í…ì³ ëª…ì‹œ í•„ìš”í•  ìˆ˜ë„ ìˆìŒ
        run: |
          IMAGE_NAME="${{ steps.set-image-name.outputs.image_name }}"
          IMAGE_TAG="${{ steps.set-image-name.outputs.image_tag }}"

          echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          echo "ì´ë¯¸ì§€: ${IMAGE_NAME}:${IMAGE_TAG}"

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì˜ Dockerfile ì‚¬ìš©)
          docker build \
            --tag "${IMAGE_NAME}:${IMAGE_TAG}" \
            --tag "${IMAGE_NAME}:latest" \
            --file Dockerfile \
            .

          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

      - name: ìƒì„±í•œ Docker image ê²€ì¦
        run: |
          IMAGE_NAME="${{ steps.set-image-name.outputs.image_name }}"
          IMAGE_TAG="${{ steps.set-image-name.outputs.image_tag }}"

          echo "ğŸ” Docker ì´ë¯¸ì§€ ê²€ì¦ ì¤‘..."

          # ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
          if ! docker images "${IMAGE_NAME}:${IMAGE_TAG}" --format "{{.Repository}}:{{.Tag}}" | grep -q "${IMAGE_NAME}:${IMAGE_TAG}"; then
            echo "âŒ ì˜¤ë¥˜: Docker ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${IMAGE_NAME}:${IMAGE_TAG})"
            echo ""
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ëª©ë¡:"
            docker images "${IMAGE_NAME}" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" || true
            exit 1
          fi

          echo "âœ“ ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸ ì™„ë£Œ"

          # ì´ë¯¸ì§€ ìƒì„¸ ì •ë³´ í™•ì¸
          echo ""
          echo "=== Docker ì´ë¯¸ì§€ ì •ë³´ ==="
          docker images "${IMAGE_NAME}" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"

          echo ""
          echo "=== ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ==="
          docker inspect "${IMAGE_NAME}:${IMAGE_TAG}" --format='
          - ìƒì„± ì‹œê°„: {{.Created}}
          - ì•„í‚¤í…ì²˜: {{.Architecture}}
          - OS: {{.Os}}
          - í¬ê¸°: {{.Size}} bytes
          - Exposed Ports: {{.Config.ExposedPorts}}
          - Entrypoint: {{.Config.Entrypoint}}
          - Cmd: {{.Config.Cmd}}'

          echo ""
          echo "âœ… Docker ì´ë¯¸ì§€ ê²€ì¦ ì™„ë£Œ"

  ## AWS Infrastructure ë°°í¬: í•„ìš”í•œ ì¸í”„ë¼ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì¤‘ë³µ ë°°í¬ëœ ì¸í”„ë¼ê°€ ìˆë‹¤ë©´, ê±´ë„ˆëœë‹ˆë‹¤.
  deploy-infrastructure-if-necessary:
    needs: build-docker-image
    runs-on: ubuntu-latest
    environment: alpha
    permissions:
      id-token: write
      contents: read

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ë¡œê·¸ì¸ ì •ë³´ ì •ì˜
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Route53 Hosted Zone í™•ì¸  # ë„ë©”ì¸ ì ‘ê·¼ ì¸ì¦ì„œ ìƒì„±ì„ ìœ„í•œ ì‚¬ì „ ì‘ì—…
        # ë„ë©”ì¸ ìƒì„±ì€ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ë¯€ë¡œ, ìµœëŒ€í•œ ë¹¨ë¦¬ ì§„í–‰í•˜ê³  ìµœì¢… ê²€ì¦ ë‹¨ê³„ì—ì„œ í™•ì¸í•´ ë¹Œë“œ ì‹œê°„ì„ ì¤„ì…ë‹ˆë‹¤.
        run: |
          ROOT_DOMAIN="ig-pilot.com"

          echo "=== Route53 Hosted Zone í™•ì¸ ==="
          echo "ë„ë©”ì¸: ${ROOT_DOMAIN}"
          echo ""

          # Hosted Zone ì¡´ì¬ í™•ì¸
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones \
            --query "HostedZones[?Name=='${ROOT_DOMAIN}.'].Id" \
            --output text 2>/dev/null | cut -d'/' -f3)

          if [ -n "$HOSTED_ZONE_ID" ]; then
            echo "âœ“ ê¸°ì¡´ Hosted Zone ì‚¬ìš©: ${HOSTED_ZONE_ID}"
          else
            echo "Hosted Zone ìƒì„± ì¤‘: ${ROOT_DOMAIN}"

            # Caller Reference (ê³ ìœ  ì‹ë³„ì)
            CALLER_REF="github-actions-$(date +%s)"

            HOSTED_ZONE_ID=$(aws route53 create-hosted-zone \
              --name "${ROOT_DOMAIN}" \
              --caller-reference "${CALLER_REF}" \
              --hosted-zone-config Comment="Created by GitHub Actions" \
              --query 'HostedZone.Id' \
              --output text | cut -d'/' -f3)

            echo "âœ“ Hosted Zone ìƒì„± ì™„ë£Œ: ${HOSTED_ZONE_ID}"
          fi

          echo ""
          echo "HOSTED_ZONE_ID=${HOSTED_ZONE_ID}" >> $GITHUB_ENV

      - name: ACM ì¸ì¦ì„œ ìƒì„± # HTTPSë¥¼ ìœ„í•œ SSL/TLS ì¸ì¦ì„œ
        run: |
          IMAGE_NAME="${{ needs.build-docker-image.outputs.image_name }}"
          DEPLOYMENT_PHASE="${{ inputs.deployment_phase }}"
          ROOT_DOMAIN="ig-pilot.com"

          echo "=== ACM ì¸ì¦ì„œ í™•ì¸ ==="

          # ë„ë©”ì¸ ì„¤ì •
          if [ "$DEPLOYMENT_PHASE" = "production" ]; then
            WILDCARD_DOMAIN="*.${IMAGE_NAME}.${ROOT_DOMAIN}"
            DOMAIN="${IMAGE_NAME}.${ROOT_DOMAIN}"
          else
            WILDCARD_DOMAIN="*.${DEPLOYMENT_PHASE}.${IMAGE_NAME}.${ROOT_DOMAIN}"
            DOMAIN="${DEPLOYMENT_PHASE}.${IMAGE_NAME}.${ROOT_DOMAIN}"
          fi

          echo "ì™€ì¼ë“œì¹´ë“œ ë„ë©”ì¸: ${WILDCARD_DOMAIN}"
          echo "ë£¨íŠ¸ ë„ë©”ì¸: ${DOMAIN}"
          echo ""

          # ê¸°ì¡´ ì¸ì¦ì„œ ê²€ìƒ‰ (ISSUED ë˜ëŠ” PENDING_VALIDATION ìƒíƒœ)
          CERTIFICATE_ARN=""
          CERT_LIST=$(aws acm list-certificates \
            --certificate-statuses ISSUED PENDING_VALIDATION \
            --region ap-northeast-2 \
            --query 'CertificateSummaryList[*].CertificateArn' \
            --output text)

          for CERT_ARN in $CERT_LIST; do
            # ì¸ì¦ì„œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
            CERT_DETAIL=$(aws acm describe-certificate \
              --certificate-arn "$CERT_ARN" \
              --region ap-northeast-2 \
              --output json)

            CERT_DOMAIN=$(echo "$CERT_DETAIL" | jq -r '.Certificate.DomainName')
            SAN_LIST=$(echo "$CERT_DETAIL" | jq -r '.Certificate.SubjectAlternativeNames[]')
            CERT_STATUS=$(echo "$CERT_DETAIL" | jq -r '.Certificate.Status')

            # ë„ë©”ì¸ ì¼ì¹˜ í™•ì¸
            if [ "$CERT_DOMAIN" = "$WILDCARD_DOMAIN" ] && echo "$SAN_LIST" | grep -q "$DOMAIN"; then
              echo "âœ“ ê¸°ì¡´ ì¸ì¦ì„œ ë°œê²¬: $CERT_ARN"
              echo "  ìƒíƒœ: $CERT_STATUS"
              CERTIFICATE_ARN="$CERT_ARN"
              break
            fi
          done

          # ì¸ì¦ì„œê°€ ì—†ìœ¼ë©´ ìƒì„±
          if [ -z "$CERTIFICATE_ARN" ]; then
            echo "ê¸°ì¡´ ì¸ì¦ì„œ ì—†ìŒ - ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤..."

            # ACM ì¸ì¦ì„œ ìš”ì²­
            echo "ACM ì¸ì¦ì„œ ìš”ì²­ ì¤‘..."
            CERTIFICATE_ARN=$(aws acm request-certificate \
              --domain-name "${WILDCARD_DOMAIN}" \
              --subject-alternative-names "${DOMAIN}" \
              --validation-method DNS \
              --region ap-northeast-2 \
              --query 'CertificateArn' \
              --output text)

            echo "âœ“ ì¸ì¦ì„œ ìš”ì²­ ì™„ë£Œ: ${CERTIFICATE_ARN}"
          fi

          echo ""
          echo "CERTIFICATE_ARN=${CERTIFICATE_ARN}" >> $GITHUB_ENV
          echo "âœ“ ì¸ì¦ì„œ ARN: ${CERTIFICATE_ARN}"

      - name: ECR ìƒì„±    # ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤
        run: |
          IMAGE_NAME="${{ needs.build-docker-image.outputs.image_name }}"
          REPOSITORY_NAME="${{ inputs.ecr_base_name }}/${IMAGE_NAME}"

          echo "=== Elastic Container Repository í™•ì¸ ==="
          echo "Repository ì´ë¦„: ${REPOSITORY_NAME}"
          echo ""

          # ë¦¬í¬ì§€í† ë¦¬ ì¡´ì¬ í™•ì¸
          if aws ecr describe-repositories --repository-names "${REPOSITORY_NAME}" --region ap-northeast-2 >/dev/null 2>&1; then
            echo "âœ“ ê¸°ì¡´ ECR ì‚¬ìš©: ${REPOSITORY_NAME}"
            REPOSITORY_URI=$(aws ecr describe-repositories --repository-names "${REPOSITORY_NAME}" --region ap-northeast-2 --query 'repositories[0].repositoryUri' --output text)
            echo "  URI: ${REPOSITORY_URI}"
          else
            # ë¦¬í¬ì§€í† ë¦¬ ìƒì„±
            echo "ECR ìƒì„± ì¤‘: ${REPOSITORY_NAME}"
            REPOSITORY_URI=$(aws ecr create-repository \
              --repository-name "${REPOSITORY_NAME}" \
              --region ap-northeast-2 \
              --image-scanning-configuration scanOnPush=true \
              --image-tag-mutability MUTABLE \
              --query 'repository.repositoryUri' \
              --output text)
            echo "âœ“ ECR ìƒì„± ì™„ë£Œ: ${REPOSITORY_URI}"
          fi

          echo ""
          echo "REPOSITORY_URI=${REPOSITORY_URI}" >> $GITHUB_ENV

      - name: ë¹Œë“œí•œ Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        run: |
          IMAGE_NAME="${{ needs.build-docker-image.outputs.image_name }}"
          IMAGE_TAG="${{ needs.build-docker-image.outputs.image_tag }}"
          REPOSITORY_URI="${{ env.REPOSITORY_URI }}"

          echo "=== Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ==="
          echo "ECR URI: ${REPOSITORY_URI}"
          echo "ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG}, latest"
          echo ""

          # ECR ë¡œê·¸ì¸
          echo "ECR ì¸ì¦ ì¤‘..."
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${REPOSITORY_URI%%/*}

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ (linux/amd64 í”Œë«í¼ - ECS Fargate ìš”êµ¬ì‚¬í•­)
          echo "Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘ (linux/amd64)..."
          docker build --platform linux/amd64 \
            -t ${REPOSITORY_URI}:${IMAGE_TAG} \
            -t ${REPOSITORY_URI}:latest \
            -f Dockerfile \
            .

          # ECRì— í‘¸ì‹œ
          echo ""
          echo "ECRì— í‘¸ì‹œ ì¤‘..."
          docker push ${REPOSITORY_URI}:${IMAGE_TAG}
          docker push ${REPOSITORY_URI}:latest

          echo ""
          echo "âœ“ Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
          echo "  - ${REPOSITORY_URI}:${IMAGE_TAG}"
          echo "  - ${REPOSITORY_URI}:latest"

      - name: ECS Cluster ìƒì„±
        run: |
          CLUSTER_NAME="${{ inputs.ecs_cluster_base_name }}"

          echo "=== ECS Cluster í™•ì¸ ==="
          echo "Cluster ì´ë¦„: ${CLUSTER_NAME}"
          echo ""

          # Cluster ì¡´ì¬ í™•ì¸
          CLUSTER_STATUS=$(aws ecs describe-clusters \
            --clusters "${CLUSTER_NAME}" \
            --region ap-northeast-2 \
            --query 'clusters[0].status' \
            --output text 2>/dev/null || echo "NONE")

          if [ "$CLUSTER_STATUS" = "ACTIVE" ]; then
            echo "âœ“ ê¸°ì¡´ ECS Cluster ì‚¬ìš©: ${CLUSTER_NAME}"
          elif [ "$CLUSTER_STATUS" = "NONE" ] || [ "$CLUSTER_STATUS" = "INACTIVE" ]; then
            # Cluster ìƒì„±
            echo "ECS Cluster ìƒì„± ì¤‘: ${CLUSTER_NAME}"
            aws ecs create-cluster \
              --cluster-name "${CLUSTER_NAME}" \
              --region ap-northeast-2 \
              --tags key=Name,value=${CLUSTER_NAME} key=ManagedBy,value=github-actions \
              > /dev/null

            echo "âœ“ ECS Cluster ìƒì„± ì™„ë£Œ: ${CLUSTER_NAME}"
          else
            echo "âš ï¸  Cluster ìƒíƒœ í™•ì¸ ë¶ˆê°€: ${CLUSTER_STATUS}"
          fi

          echo ""
          echo "CLUSTER_NAME=${CLUSTER_NAME}" >> $GITHUB_ENV

      - name: ECS Task Definition ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤)
        run: |
          echo "work in progress"

      - name: ALB ë° Target Group ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤)
        run: |
          echo "work in progress"

      - name: ECS Service ë°°í¬ # Alpha/Beta: (Fargate Spot), Production: (Fargate On-Demand)
        run: |
          echo "work in progress"

      - name: ACM ì¸ì¦ì„œ ìƒì„± # Alpha/Beta - `*.{app_name}.ig-pilot.com`, Production: `*.{app_name}.ig-pilot.com`
        run: |
          echo "work in progress"

      - name: Route 53 DNS ë ˆì½”ë“œ ìƒì„± (ig-pilot.com í˜¸ìŠ¤íŒ… ì¡´ì— ë ˆì½”ë“œ ì¶”ê°€)
        run: |
          echo "work in progress"

  ## ë°°í¬ ëª¨ë‹ˆí„°ë§: ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
  monitor-deployment:
    needs: deploy-infrastructure-if-necessary
    runs-on: ubuntu-latest
    environment: alpha
    permissions:
      id-token: write
      contents: read
    steps:
      - name: ECS ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        run: |
          echo "work in progress"

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ë°°í¬ ì—¬ë¶€ í™•ì¸
        run: |
          echo "work in progress"

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "work in progress"
