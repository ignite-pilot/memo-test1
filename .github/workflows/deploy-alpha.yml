name: Alpha ë°°í¬

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker ì´ë¯¸ì§€ ì´ë¦„ (ê¸°ë³¸ê°’: repository ì´ë¦„)'
        required: false
        type: string

jobs:
  ## Docker image ë¹Œë“œ: ì• í”Œë¦¬ì¼€ì´ì…˜ì„ íŒ¨í‚¤ì§•í•©ë‹ˆë‹¤.
  build-docker-image:
    runs-on: ubuntu-latest
    environment: alpha
    permissions:
      id-token: write
      contents: read
    outputs:
      image_name: ${{ steps.set-image-name.outputs.image_name }}
      image_tag: ${{ steps.set-image-name.outputs.image_tag }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì´ë¯¸ì§€ ì´ë¦„ ë° íƒœê·¸ ì„¤ì •
        id: set-image-name
        run: |
          # Inputìœ¼ë¡œ ì´ë¯¸ì§€ ì´ë¦„ì´ ì œê³µë˜ì—ˆìœ¼ë©´ ì‚¬ìš©, ì•„ë‹ˆë©´ repository ì´ë¦„ ì‚¬ìš©
          if [ -n "${{ inputs.image_name }}" ]; then
            IMAGE_NAME="${{ inputs.image_name }}"
          else
            IMAGE_NAME="${{ github.event.repository.name }}"
          fi

          # íƒœê·¸ëŠ” git commit SHAì˜ ì§§ì€ ë²„ì „ ì‚¬ìš©
          IMAGE_TAG="${{ github.sha }}"
          IMAGE_TAG_SHORT="${IMAGE_TAG:0:7}"

          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG_SHORT}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ì´ë¦„: ${IMAGE_NAME}"
          echo "ğŸ·ï¸  Docker ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG_SHORT}"

      - name: Docker image ìƒì„±(ì• í”Œë¦¬ì¼€ì´ì…˜ íŒ¨í‚¤ì§•)
        run: |
          IMAGE_NAME="${{ steps.set-image-name.outputs.image_name }}"
          IMAGE_TAG="${{ steps.set-image-name.outputs.image_tag }}"

          echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          echo "ì´ë¯¸ì§€: ${IMAGE_NAME}:${IMAGE_TAG}"

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì˜ Dockerfile ì‚¬ìš©)
          docker build \
            --tag "${IMAGE_NAME}:${IMAGE_TAG}" \
            --tag "${IMAGE_NAME}:latest" \
            --file Dockerfile \
            .

          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

      - name: ìƒì„±í•œ Docker image ê²€ì¦
        run: |
          IMAGE_NAME="${{ steps.set-image-name.outputs.image_name }}"
          IMAGE_TAG="${{ steps.set-image-name.outputs.image_tag }}"

          echo "ğŸ” Docker ì´ë¯¸ì§€ ê²€ì¦ ì¤‘..."

          # ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
          if ! docker images | grep -q "${IMAGE_NAME}"; then
            echo "âŒ ì˜¤ë¥˜: Docker ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "âœ“ ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸ ì™„ë£Œ"

          # ì´ë¯¸ì§€ ìƒì„¸ ì •ë³´ í™•ì¸
          echo ""
          echo "=== Docker ì´ë¯¸ì§€ ì •ë³´ ==="
          docker images "${IMAGE_NAME}" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"

          # ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ê²€ì¦
          echo ""
          echo "=== ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ==="
          docker inspect "${IMAGE_NAME}:${IMAGE_TAG}" --format='
          - ìƒì„± ì‹œê°„: {{.Created}}
          - ì•„í‚¤í…ì²˜: {{.Architecture}}
          - OS: {{.Os}}
          - í¬ê¸°: {{.Size}} bytes
          - Exposed Ports: {{.Config.ExposedPorts}}
          - Entrypoint: {{.Config.Entrypoint}}
          - Cmd: {{.Config.Cmd}}'

          # ê°„ë‹¨í•œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ (í—¬ìŠ¤ì²´í¬ í™•ì¸)
          echo ""
          echo "=== ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ==="
          echo "ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê³  í—¬ìŠ¤ì²´í¬ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."

          # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ, ìë™ ì‚­ì œ)
          CONTAINER_ID=$(docker run -d --rm \
            -p 8501:8501 \
            -e DATABASE_URL="postgresql://test:test@localhost:5432/test" \
            "${IMAGE_NAME}:${IMAGE_TAG}")

          echo "ì»¨í…Œì´ë„ˆ ID: ${CONTAINER_ID}"

          # ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 30ì´ˆ)
          echo "ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          for i in {1..30}; do
            if docker ps | grep -q "${CONTAINER_ID}"; then
              echo "âœ“ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤ (${i}ì´ˆ ê²½ê³¼)"
              break
            fi

            # ì»¨í…Œì´ë„ˆê°€ ì‹¤íŒ¨í–ˆëŠ”ì§€ í™•ì¸
            if ! docker ps -a | grep -q "${CONTAINER_ID}"; then
              echo "âŒ ì˜¤ë¥˜: ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
              docker logs "${CONTAINER_ID}" 2>&1 || true
              exit 1
            fi

            sleep 1
          done

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo ""
          echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker ps --filter "id=${CONTAINER_ID}" --format "table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

          # ë¡œê·¸ í™•ì¸ (ì²˜ìŒ 20ì¤„)
          echo ""
          echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ì²˜ìŒ 20ì¤„):"
          docker logs "${CONTAINER_ID}" 2>&1 | head -n 20

          # ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          echo ""
          echo "ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
          docker stop "${CONTAINER_ID}" || true

          echo ""
          echo "âœ… Docker ì´ë¯¸ì§€ ê²€ì¦ ì™„ë£Œ"

  ## AWS Infrastructure ë°°í¬: í•„ìš”í•œ ì¸í”„ë¼ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì¤‘ë³µ ë°°í¬ëœ ì¸í”„ë¼ê°€ ìˆë‹¤ë©´, ê±´ë„ˆëœë‹ˆë‹¤.
  deploy-infrastructure-if-necessary:
    runs-on: ubuntu-latest
    environment: alpha
    permissions:
      id-token: write
      contents: read

    steps:
      - name: AWS ë¡œê·¸ì¸ ì •ë³´ ì •ì˜
        run: |
          echo "work in progress"

      - name: ECR Repository ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤)
        run: |
          echo "work in progress"

      - name: ë¹Œë“œí•œ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (linux/amd64)
        run: |
          echo "work in progress"

      - name: ACM ì¸ì¦ì„œ ìƒì„± # Alpha/Beta - `*.{app_name}.ig-pilot.com`, Production: `*.{app_name}.ig-pilot.com`
        run: |
          echo "work in progress"

      - name: ECS Cluster ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤) # cluster name: aws-deploy-wizard
        run: |
          echo "work in progress"

      - name: ECS Task Definition ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤)
        run: |
          echo "work in progress"

      - name: ALB ë° Target Group ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤)
        run: |
          echo "work in progress"

      - name: ECS Service ë°°í¬ # Alpha/Beta: (Fargate Spot), Production: (Fargate On-Demand)
        run: |
          echo "work in progress"

      - name: Route 53 DNS ë ˆì½”ë“œ ìƒì„± (ig-pilot.com í˜¸ìŠ¤íŒ… ì¡´ì— ë ˆì½”ë“œ ì¶”ê°€)
        run: |
          echo "work in progress"

  ## ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬: Docker ì´ë¯¸ì§€ë¥¼ AWS ECSì— ë°°í¬í•©ë‹ˆë‹¤.
  monitor-deployment:
    runs-on: ubuntu-latest
    environment: alpha
    permissions:
      id-token: write
      contents: read
    steps:
      - name: ECS ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        run: |
          echo "work in progress"

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ë°°í¬ ì—¬ë¶€ í™•ì¸
        run: |
          echo "work in progress"

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "work in progress"
