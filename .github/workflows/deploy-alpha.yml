name: Alpha ë°°í¬

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker ì´ë¯¸ì§€ ì´ë¦„ (ê¸°ë³¸ê°’: repository ì´ë¦„)'
        required: false
        type: string
      health_check_path:
        description: 'Health check endpoint ê²½ë¡œ (ê¸°ë³¸ê°’: /api/health)'
        required: false
        type: string
        default: '/api/health'

jobs:
  ## Docker image ë¹Œë“œ: ì• í”Œë¦¬ì¼€ì´ì…˜ì„ íŒ¨í‚¤ì§•í•©ë‹ˆë‹¤.
  build-docker-image:
    runs-on: ubuntu-latest
    environment: alpha
    permissions:
      id-token: write
      contents: read
    outputs:
      image_name: ${{ steps.set-image-name.outputs.image_name }}
      image_tag: ${{ steps.set-image-name.outputs.image_tag }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì´ë¯¸ì§€ ì´ë¦„ ë° íƒœê·¸ ì„¤ì •
        id: set-image-name
        run: |
          # Inputìœ¼ë¡œ ì´ë¯¸ì§€ ì´ë¦„ì´ ì œê³µë˜ì—ˆìœ¼ë©´ ì‚¬ìš©, ì•„ë‹ˆë©´ repository ì´ë¦„ ì‚¬ìš©
          if [ -n "${{ inputs.image_name }}" ]; then
            IMAGE_NAME="${{ inputs.image_name }}"
          else
            IMAGE_NAME="${{ github.event.repository.name }}"
          fi

          # íƒœê·¸ëŠ” git commit SHAì˜ ì§§ì€ ë²„ì „ ì‚¬ìš©
          IMAGE_TAG="${{ github.sha }}"
          IMAGE_TAG_SHORT="${IMAGE_TAG:0:7}"

          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG_SHORT}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ì´ë¦„: ${IMAGE_NAME}"
          echo "ğŸ·ï¸  Docker ì´ë¯¸ì§€ íƒœê·¸: ${IMAGE_TAG_SHORT}"

      - name: Docker image ìƒì„±(ì• í”Œë¦¬ì¼€ì´ì…˜ íŒ¨í‚¤ì§•)
        run: |
          IMAGE_NAME="${{ steps.set-image-name.outputs.image_name }}"
          IMAGE_TAG="${{ steps.set-image-name.outputs.image_tag }}"

          echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          echo "ì´ë¯¸ì§€: ${IMAGE_NAME}:${IMAGE_TAG}"

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì˜ Dockerfile ì‚¬ìš©)
          docker build \
            --tag "${IMAGE_NAME}:${IMAGE_TAG}" \
            --tag "${IMAGE_NAME}:latest" \
            --file Dockerfile \
            .

          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

      - name: ìƒì„±í•œ Docker image ê²€ì¦
        run: |
          IMAGE_NAME="${{ steps.set-image-name.outputs.image_name }}"
          IMAGE_TAG="${{ steps.set-image-name.outputs.image_tag }}"

          echo "ğŸ” Docker ì´ë¯¸ì§€ ê²€ì¦ ì¤‘..."

          # ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
          if ! docker images "${IMAGE_NAME}:${IMAGE_TAG}" --format "{{.Repository}}:{{.Tag}}" | grep -q "${IMAGE_NAME}:${IMAGE_TAG}"; then
            echo "âŒ ì˜¤ë¥˜: Docker ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${IMAGE_NAME}:${IMAGE_TAG})"
            echo ""
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ëª©ë¡:"
            docker images "${IMAGE_NAME}" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" || true
            exit 1
          fi

          echo "âœ“ ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸ ì™„ë£Œ"

          # ì´ë¯¸ì§€ ìƒì„¸ ì •ë³´ í™•ì¸
          echo ""
          echo "=== Docker ì´ë¯¸ì§€ ì •ë³´ ==="
          docker images "${IMAGE_NAME}" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"

          echo ""
          echo "=== ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ==="
          docker inspect "${IMAGE_NAME}:${IMAGE_TAG}" --format='
          - ìƒì„± ì‹œê°„: {{.Created}}
          - ì•„í‚¤í…ì²˜: {{.Architecture}}
          - OS: {{.Os}}
          - í¬ê¸°: {{.Size}} bytes
          - Exposed Ports: {{.Config.ExposedPorts}}
          - Entrypoint: {{.Config.Entrypoint}}
          - Cmd: {{.Config.Cmd}}'

          echo ""
          echo "âœ… Docker ì´ë¯¸ì§€ ê²€ì¦ ì™„ë£Œ"

  ## AWS Infrastructure ë°°í¬: í•„ìš”í•œ ì¸í”„ë¼ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì¤‘ë³µ ë°°í¬ëœ ì¸í”„ë¼ê°€ ìˆë‹¤ë©´, ê±´ë„ˆëœë‹ˆë‹¤.
  deploy-infrastructure-if-necessary:
    needs: build-docker-image
    runs-on: ubuntu-latest
    environment: alpha
    permissions:
      id-token: write
      contents: read

    steps:
      - name: AWS ë¡œê·¸ì¸ ì •ë³´ ì •ì˜
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ECR Repository ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤)
        run: |
          echo "work in progress"

      - name: ë¹Œë“œí•œ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (linux/amd64)
        run: |
          echo "work in progress"

      - name: ACM ì¸ì¦ì„œ ìƒì„± # Alpha/Beta - `*.{app_name}.ig-pilot.com`, Production: `*.{app_name}.ig-pilot.com`
        run: |
          echo "work in progress"

      - name: ECS Cluster ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤) # cluster name: aws-deploy-wizard
        run: |
          echo "work in progress"

      - name: ECS Task Definition ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤)
        run: |
          echo "work in progress"

      - name: ALB ë° Target Group ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœë‹ˆë‹¤)
        run: |
          echo "work in progress"

      - name: ECS Service ë°°í¬ # Alpha/Beta: (Fargate Spot), Production: (Fargate On-Demand)
        run: |
          echo "work in progress"

      - name: Route 53 DNS ë ˆì½”ë“œ ìƒì„± (ig-pilot.com í˜¸ìŠ¤íŒ… ì¡´ì— ë ˆì½”ë“œ ì¶”ê°€)
        run: |
          echo "work in progress"

  ## ë°°í¬ ëª¨ë‹ˆí„°ë§: ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
  monitor-deployment:
    needs: deploy-infrastructure-if-necessary
    runs-on: ubuntu-latest
    environment: alpha
    permissions:
      id-token: write
      contents: read
    steps:
      - name: ECS ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        run: |
          echo "work in progress"

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ë°°í¬ ì—¬ë¶€ í™•ì¸
        run: |
          echo "work in progress"

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "work in progress"
